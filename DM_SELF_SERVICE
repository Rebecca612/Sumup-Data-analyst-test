create or replace view DM_SELF_SERVICE as

with base as (

    SELECT
        date_trunc('month', w.DATE) as DATE,
        w.COUNTRY_CODE,
        c.CHANNEL_3,
        SUM(w.TOTAL_SPEND_EUR) AS MARKETING_SPEND,
        SUM(w.NB_OF_SESSIONS) AS TOTAL_SESSIONS,
        SUM(w.NB_OF_SIGNUPS) AS TOTAL_SIGNUPS,
        SUM(w.NB_OF_ORDERS) AS TOTAL_ORDERS

    FROM WEB_ORDERS_BRONZE w
    LEFT JOIN stg_channels c
        ON w.campaign_id = c.campaign_id

    WHERE w.DATE IS NOT NULL
    GROUP BY 1,2,3
)

SELECT
    DATE,
    COUNTRY_CODE,
    CHANNEL_3,
    MARKETING_SPEND,
    TOTAL_SESSIONS,
    TOTAL_SIGNUPS,
    TOTAL_ORDERS,

    MARKETING_SPEND / NULLIF(TOTAL_ORDERS,0) AS COST_PER_ORDER,
    TOTAL_ORDERS / NULLIF(TOTAL_SESSIONS,0) AS SESSION_TO_ORDER_RATE,
    TOTAL_SIGNUPS / NULLIF(TOTAL_SESSIONS,0) AS SESSION_TO_SIGNUP_RATE,
    TOTAL_ORDERS / NULLIF(TOTAL_SIGNUPS,0) AS SIGNUP_TO_ORDER_RATE

FROM base;
