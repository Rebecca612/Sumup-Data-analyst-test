create or replace view DM_SELF_SERVICE(
	S_DATE,
	COUNTRY_CODE,
	CAMPAIGN_BUDGET_CATEGORY,
	CHANNEL_3,
	MARKETING_SPEND,
	NB_OF_SESSIONS,
	NB_OF_SIGNUPS,
	NB_OF_ORDERS,
	POS_LITE_DEALS,
	COST_PER_SIGNUP,
	COST_PER_ORDER,
	SESSION_TO_SIGNUP_RATE,
	SIGNUP_TO_ORDER_RATE
) as

SELECT
    date_trunc('month',DATE) as S_Date,
    COUNTRY_CODE,
    c.campaign_budget_category,
    c.channel_3,
    round(SUM(TOTAL_SPEND_EUR),3) AS MARKETING_SPEND,
    round(SUM(NB_OF_SESSIONS),3) AS NB_OF_SESSIONS,
    round(SUM(NB_OF_SIGNUPS),3) AS NB_OF_SIGNUPS,
    round(SUM(NB_OF_ORDERS),3) AS NB_OF_ORDERS,
    round(SUM(NB_OF_POSLITE_ITEMS_ORDERED),3) AS POS_LITE_DEALS,

    -- KPIs (calculated AFTER aggregation)
    CASE WHEN SUM(NB_OF_SIGNUPS) > 0
        THEN round(SUM(TOTAL_SPEND_EUR) / SUM(NB_OF_SIGNUPS),3)
    END AS COST_PER_SIGNUP,

    CASE WHEN SUM(NB_OF_ORDERS) > 0
        THEN round(SUM(TOTAL_SPEND_EUR) / SUM(NB_OF_ORDERS),3)
    END AS COST_PER_ORDER,

    CASE WHEN SUM(NB_OF_SESSIONS) > 0
        THEN round(SUM(NB_OF_SIGNUPS) / SUM(NB_OF_SESSIONS),3)
    END AS SESSION_TO_SIGNUP_RATE,

    CASE WHEN SUM(NB_OF_SIGNUPS) > 0
        THEN round(SUM(NB_OF_ORDERS) / SUM(NB_OF_SIGNUPS),3)
    END AS SIGNUP_TO_ORDER_RATE

FROM WEB_ORDERS_BRONZE w
left join stg_channels c
on w.campaign_id= c.campaign_id
where date is not null
GROUP BY 1,2,3,4;
;
