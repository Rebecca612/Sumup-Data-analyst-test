create or replace view DM_SALES_ASSISTED(
	DATE,
	CHANNEL_3,
	MARKETING_SPEND,
	TOTAL_LEADS,
	TOTAL_SQLS,
	TOTAL_MEETING_DONE,
	TOTAL_SIGNED_LEADS,
	TOTAL_POS_LITE_DEALS,
	COST_PER_LEAD,
	FUNNEL_EFFICIENCY,
	SQL_TO_MEETING_RATE
) as

with base as (

    SELECT
        date_trunc('month', l.DATE) as DATE,
        channel_3,
        SUM(l.TOTAL_SPEND) AS MARKETING_SPEND,
        SUM(l.TOTAL_LEADS) AS TOTAL_LEADS,
        SUM(l.TOTAL_SQLS) AS TOTAL_SQLS,
        SUM(l.TOTAL_MEETING_DONE) AS TOTAL_MEETING_DONE,
        SUM(l.TOTAL_SIGNED_LEADS) AS TOTAL_SIGNED_LEADS,
        SUM(l.TOTAL_POS_LITE_DEALS) AS TOTAL_POS_LITE_DEALS

    FROM LEADS_FUNNEL_BRONZE l

    GROUP BY 1,2
)

SELECT
    DATE,
    channel_3,
    MARKETING_SPEND,
    TOTAL_LEADS,
    TOTAL_SQLS,
    TOTAL_MEETING_DONE,
    TOTAL_SIGNED_LEADS,
    TOTAL_POS_LITE_DEALS,

    ROUND(MARKETING_SPEND / NULLIF(TOTAL_LEADS,0),3) AS COST_PER_LEAD,
    ROUND(TOTAL_POS_LITE_DEALS / NULLIF(TOTAL_LEADS,0),3) AS FUNNEL_EFFICIENCY,
    ROUND(TOTAL_MEETING_DONE / NULLIF(TOTAL_SQLS,0),3) AS SQL_TO_MEETING_RATE

FROM base;
