CREATE OR REPLACE VIEW dm_SALES_ASSISTED AS

SELECT
    DATE,
    COUNTRY_CODE,
    c.campaign_budget_category,
    c.channel_3,
    SUM(TOTAL_SPEND) AS MARKETING_SPEND,
    SUM(TOTAL_LEADS) AS TOTAL_LEADS,
    SUM(TOTAL_SQLS) AS TOTAL_SQLS,
    SUM(TOTAL_MEETING_DONE) AS TOTAL_MEETING_DONE,
    SUM(TOTAL_SIGNED_LEADS) AS TOTAL_SIGNED_LEADS,
    SUM(TOTAL_POS_LITE_DEALS) AS TOTAL_POS_LITE_DEALS,

    -- KPIs (calculated AFTER aggregation)
    CASE WHEN SUM(TOTAL_LEADS) > 0
        THEN round(SUM(TOTAL_SPEND) / SUM(TOTAL_LEADS),3)
    END AS COST_PER_LEAD,

    CASE WHEN SUM(TOTAL_LEADS) > 0
        THEN round(SUM(TOTAL_POS_LITE_DEALS) / SUM(TOTAL_LEADS),3)
    END AS FUNNEL_EFFICIENCY,

    CASE WHEN SUM(TOTAL_SQLS) > 0
        THEN round(SUM(TOTAL_MEETING_DONE) / SUM(TOTAL_SQLS),3)
    END AS SQL_TO_MEETING_RATE
FROM LEADS_FUNNEL_BRONZE l
join stg_channels c
on l.campaign_id=c.campaign_id
GROUP BY 1,2,3,4;
