create or replace view DM_SALES_ASSISTED as
with base as (

    SELECT
        date_trunc('month', l.DATE) as DATE,
        c.channel_3,
        SUM(l.TOTAL_SPEND) AS MARKETING_SPEND,
        SUM(l.TOTAL_LEADS) AS TOTAL_LEADS,
        SUM(l.TOTAL_SQLS) AS TOTAL_SQLS,
        SUM(l.TOTAL_MEETING_DONE) AS TOTAL_MEETING_DONE,
        SUM(l.TOTAL_SIGNED_LEADS) AS TOTAL_SIGNED_LEADS,
        SUM(l.TOTAL_POS_LITE_DEALS) AS SALES_ASSISTED_DEALS

    FROM LEADS_FUNNEL_BRONZE l
    LEFT JOIN stg_channels c
        ON l.campaign_id = c.campaign_id

    GROUP BY 1,2
)

SELECT
    DATE,
    CHANNEL_3,
    MARKETING_SPEND,
    TOTAL_LEADS,
    TOTAL_SQLS,
    TOTAL_MEETING_DONE,
    TOTAL_SIGNED_LEADS,
    SALES_ASSISTED_DEALS,

    MARKETING_SPEND / NULLIF(TOTAL_LEADS,0) AS COST_PER_LEAD,
    SALES_ASSISTED_DEALS / NULLIF(TOTAL_LEADS,0) AS LEAD_TO_DEAL_RATE,
    TOTAL_SQLS / NULLIF(TOTAL_LEADS,0) AS LEAD_TO_SQL_RATE,
    TOTAL_SIGNED_LEADS / NULLIF(TOTAL_SQLS,0) AS SQL_TO_SIGNED_RATE

FROM base;
