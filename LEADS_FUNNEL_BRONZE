create or replace view LEADS_FUNNEL_BRONZE(
	DATE,
	CURRENCY,
	COUNTRY_CODE,
	CAMPAIGN_ID,
	CAMPAIGN_NAME,
	PRODUCT,
	CHANNEL_3,
	CHANNEL_4,
	CHANNEL_5,
	TOTAL_IMPRESSIONS,
	TOTAL_CLICKS,
	TOTAL_SPEND,
	TOTAL_LEADS,
	TOTAL_FAKE_LEADS,
	TOTAL_SQLS,
	TOTAL_MEETING_DONE,
	TOTAL_SIGNED_LEADS,
	TOTAL_POS_LITE_DEALS
) as
SELECT

    DATE,

    UPPER(TRIM(CURRENCY)) AS CURRENCY,

    CASE 
        WHEN LOWER(TRIM(COUNTRY_CODE)) = 'unknown' THEN NULL
        ELSE UPPER(TRIM(COUNTRY_CODE))
    END AS COUNTRY_CODE,

    CAST(CAMPAIGN_ID AS NUMBER(38,0)) AS CAMPAIGN_ID,

    TRIM(CAMPAIGN_NAME) AS CAMPAIGN_NAME,

    -- Product normalization
    CASE 
        WHEN LOWER(TRIM(PRODUCT)) IN ('unknown', '') THEN NULL
        WHEN LOWER(PRODUCT) LIKE '%poslite%' THEN 'POS_LITE'
        WHEN LOWER(PRODUCT) LIKE '%pos-lite%' THEN 'POS_LITE'
        WHEN LOWER(PRODUCT) LIKE '%pos%' THEN 'POS'
        ELSE UPPER(TRIM(PRODUCT))
    END AS PRODUCT,

    NULLIF(TRIM(CHANNEL_3), '') AS CHANNEL_3,
    NULLIF(TRIM(CHANNEL_4), '') AS CHANNEL_4,
    NULLIF(TRIM(CHANNEL_5), '') AS CHANNEL_5,

    -- Replace NULL metrics with 0
    COALESCE(TOTAL_IMPRESSIONS, 0) AS TOTAL_IMPRESSIONS,
    COALESCE(TOTAL_CLICKS, 0) AS TOTAL_CLICKS,
    COALESCE(TOTAL_SPEND, 0) AS TOTAL_SPEND,
    COALESCE(TOTAL_LEADS, 0) AS TOTAL_LEADS,
    COALESCE(TOTAL_FAKE_LEADS, 0) AS TOTAL_FAKE_LEADS,
    COALESCE(TOTAL_SQLS, 0) AS TOTAL_SQLS,
    COALESCE(TOTAL_MEETING_DONE, 0) AS TOTAL_MEETING_DONE,
    COALESCE(TOTAL_SIGNED_LEADS, 0) AS TOTAL_SIGNED_LEADS,
    COALESCE(TOTAL_POS_LITE_DEALS, 0) AS TOTAL_POS_LITE_DEALS

FROM DATEV_TEST.DATEV_TEST.LEADS_FUNNEL;
